name: CI/CD SGE Test with Newman

on:
  push:
    branches: [main, dev]
  pull_request: 
    branches: [main, dev]
    
    
jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du code
      - name: Checkout repo
        uses: actions/checkout@v4
      
      # 2Ô∏è‚É£ Installation de Docker Compose (inclus dans docker-cli maintenant)  
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 3Ô∏è‚É£ Lancement du docker-compose (API + Postgres)  
      - name: Start Docker Compose
        run: docker compose -f compose.yaml up -d

      - name: Show compose services
        run: docker compose -f compose.yaml ps 
        
      - name: API logs
        run: docker compose -f compose.yaml logs sge_api
        
      - name: Show API logs
        run: docker compose -f compose.yaml logs sge_api
          
      # 4Ô∏è‚É£ Attendre que l‚ÄôAPI soit pr√™te
      - name: Wait for API to be ready
        run:  |
          for i in $(seq 1 60); do
            if curl -sSf http://localhost:8080/api/departments > /dev/null 2>&1; then
              echo "API ready" && exit 0
            fi
            echo "Waiting for API..." && sleep 2
          done
          echo "API did not start in time" && docker compose -f compose.yaml logs sge_api && exit 1
          docker compose -f compose.yaml logs
          exit 1
          
      # 5Ô∏è‚É£ Installation de Newman
      - name: Install Newman
        run: npm install -g newman
          
      # üîµ Ex√©cuter la collection Postman
      - name: Run Postman tests
        run: |
          newman run ./testPostman/SGE_NET9_GITHUB_ACTION.postman_collection.json \
            --env-var base_url=http://localhost:8080 \
            --reporters cli,junit \
            --reporter-junit-export newman-results.xml
          
      # üü° Sauvegarder le rapport comme artefact
      - name: Upload Newman test report
        uses: actions/upload-artifact@v4
        with:
          name: newman-report
          path: newman-results.xml
            
      # 6Ô∏è‚É£ Affichage des logs en cas d‚Äô√©chec
      - name: Docker logs
        if: failure()
        run: docker compose -f compose.yaml logs